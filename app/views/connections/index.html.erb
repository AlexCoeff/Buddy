
<h1>  All Your Buddies </h1>

<div class="connections">
  <% seen_jobs = [] %>
  <% seen_contacts = [] %>
  <% previous_contact = nil %>

  <% @connections.each_with_index do |connection, index| %>
    <% contact = @connections[index] %>
    <% jobs_per_connections = connection.company.jobs.select do |job| %>
      <% !((seen_contacts.include?(contact.id) && seen_jobs.include?(job.id)) || (current_user.match_priority_to_job(job.title) == false && !current_user.matches_at_least_one_job(connection.company.jobs))) %>
    <% end %>

    <% connection.company.jobs.each do |job| %>
      <% next if previous_contact == contact %>
        <% unless (seen_contacts.include?(contact.id) && seen_jobs.include?(job.id)) || !current_user.matches_at_least_one_job(connection.company.jobs) %>

          <div class="connections-wrapper">
            <div class="card-connection">
              <img src="https://res.cloudinary.com/maximelpy/image/upload/v1605906126/ny5oq93lqza9mpul45o6d43hdjcd.jpg" alt="" class="card-image">
              <div class="card-connection-details">
                <h1><%= contact&.first_name%> <%= contact&.last_name%></h1>
                <h2><%= contact&.job_title%> @ <%= contact&.company&.name%></h2>
                <% connection = Connection.find_by(contact: contact) %>
                <h3><%= connection&.duration_work %></h3>
              </div>
            </div>
          </div>

          <div class="job-container">

            <% jobs_per_connections.each do |job_per_connection| %>
              <% next if current_user.match_priority_to_job(job_per_connection.title) == false %>

              <div>
                <div class="job-card" onclick="window.toggleDescription(this)">
                  <li class="priority_<%= current_user.match_priority_to_job(job_per_connection.title) %> ">
                  <%= job_per_connection.title %>
                  </li>
                </div>

                <div class="job-desc-container" style="display:none;">
                  <%= job_per_connection.description.html_safe %>

                <div class="btn">
                  <% if contact&.is_a_user? %>
                    <%= link_to " Connect with your Buddy", user_conversations_path(connection.contact.user_id), method: :post %>
                  <% else %>
                    <%= link_to " send an e-mail" %>
                  <% end %>
                </div>
                </div>
              </div>

            <% end %>
            <% end %>
          </div>



        <% seen_jobs.push(job.id) %>
        <% seen_contacts.push(contact.id) %>
        <% previous_contact = contact %>

    <% end %>
  <% end %>
</div>


